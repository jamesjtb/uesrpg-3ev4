<form class="{{cssClass}}" autocomplete="off">
  <div class="sheet-section-container">
    <div class="sheet-fixed-container">
      <div class="character-profile-container">
        <div class="profile-img-container">
          <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}">
        </div>
        <div>
          <h1 class="charname"><input type="text" name="name" value="{{actor.name}}" placeholder="Group Name"></h1>
        </div>
        <nav class="sheet-tabs tabs" data-group="primary">
          <a class="item" data-tab="members">Members</a>
          <a class="item" data-tab="inventory">Inventory</a>
          <a class="item" data-tab="travel">Travel</a>
          <a class="item" data-tab="details">Details</a>
        </nav>
      </div>
    </div>

    <section class="sheet-body">

      <!-- Members Tab -->
      <div class="tab members" data-group="primary" data-tab="members">
        <!-- Drop zone stays at top -->
        <div class="member-drop-zone" style="border: 2px dashed #999; padding: 15px; margin-bottom: 15px; text-align: center; background: rgba(255,255,255,0.05);">
          <i class="fas fa-users" style="font-size: 1.5em; opacity: 0.5;"></i>
          <p style="margin: 8px 0 0 0; opacity: 0.7; font-size: 0.95em;">
            {{#if editable}}Drag actors here to add them to this group{{else}}Group Members{{/if}}
          </p>
        </div>

        {{#if resolvedMembers.length}}
        <!-- Controls row -->
        <div class="controls" style="margin-bottom: 15px; display: flex; gap: 8px;">
          {{#if isGM}}
          <button type="button" class="deploy-group" style="flex: 1; padding: 6px 10px; font-size: 0.9em;">
            <i class="fas fa-chess-board"></i> Deploy Group
          </button>
          {{/if}}
          <button type="button" class="short-rest" style="flex: 1; padding: 6px 10px; font-size: 0.9em;">
            <i class="fas fa-coffee"></i> Short Rest
          </button>
          <button type="button" class="long-rest" style="flex: 1; padding: 6px 10px; font-size: 0.9em;">
            <i class="fas fa-bed"></i> Long Rest
          </button>
        </div>

        <!-- Member list with guaranteed visibility -->
        <div class="member-list-scrollable" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding-right: 5px;">
          {{#each resolvedMembers as |member|}}
          <div class="member-item" data-uuid="{{member.uuid}}" 
               style="display: grid; grid-template-columns: auto 1fr auto; grid-template-rows: auto auto; gap: 8px 10px; padding: 8px; border: 1px solid #999; border-radius: 4px; background: rgba(255,255,255,0.03); align-items: center;">
            
            <!-- Portrait spans 2 rows -->
            <div class="member-portrait" style="cursor: pointer; grid-row: 1 / 3; grid-column: 1;">
              <img src="{{member.img}}" width="40" height="40" title="{{member.name}}" 
                   style="border-radius: 4px; object-fit: cover; display: block; {{#if member.missing}}opacity: 0.5; filter: grayscale(100%);{{/if}}">
            </div>

            <!-- Name in row 1, column 2 -->
            <div class="member-name" style="cursor: pointer; font-weight: bold; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; grid-row: 1; grid-column: 2;">
              {{member.name}}
              {{#if member.missing}}<span style="color: #d9534f; font-size: 0.85em;">(Missing)</span>{{/if}}
            </div>
            
            <!-- Stats in row 2, column 2 -->
            {{#if member.canView}}
            <div class="member-stats" style="display: flex; gap: 10px; font-size: 0.8em; flex-wrap: wrap; grid-row: 2; grid-column: 2;">
              <span title="Health Points"><i class="fas fa-heart" style="color: #c03030;"></i> {{member.hp.value}}/{{member.hp.max}}</span>
              <span title="Stamina Points"><i class="fas fa-bolt" style="color: #30a0c0;"></i> {{member.stamina.value}}/{{member.stamina.max}}</span>
              {{#if member.magicka}}<span title="Magicka Points"><i class="fas fa-hat-wizard" style="color: #9030c0;"></i> {{member.magicka.value}}/{{member.magicka.max}}</span>{{/if}}
              <span title="Speed"><i class="fas fa-running" style="color: #60c030;"></i> {{member.speed}}</span>
              {{#if member.fatigue}}<span style="color: #d9534f;" title="Fatigue Level"><i class="fas fa-exclamation-triangle"></i> Fatigue {{member.fatigue}}</span>{{/if}}
            </div>
            {{/if}}

            <!-- Delete button spans 2 rows, column 3 -->
            {{#if ../editable}}
            <button type="button" class="member-delete" title="Remove from group" 
                    style="grid-row: 1 / 3; grid-column: 3; width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; background: rgba(200,0,0,0.15); border: 1px solid rgba(200,0,0,0.4); border-radius: 3px; cursor: pointer; font-size: 0.85em;">
              <i class="fas fa-times"></i>
            </button>
            {{/if}}
          </div>
          {{/each}}
        </div>
        {{else}}
        <p style="text-align: center; opacity: 0.6; margin-top: 30px; font-style: italic;">No members in this group.</p>
        {{/if}}
      </div>

      <!-- Inventory Tab -->
      <div class="tab inventory" data-group="primary" data-tab="inventory">
        <div class="inventory-header" style="border-bottom: 2px solid #999; padding-bottom: 8px; margin-bottom: 15px;">
          <h3 style="margin: 0 0 5px 0;">Group Inventory</h3>
          <p style="opacity: 0.7; font-size: 0.9em; margin: 0;">Drag items here to add to group inventory</p>
        </div>
        
        <div class="itemListContainer" style="max-height: 500px; overflow-y: auto;">
          <!-- Containers -->
          <div class="containerList">
            <table class="container-table">
              <thead>
                <tr>
                  <th class="item-name-cell item-create" id="container">Containers +</th>
                  <th>Capacity</th>
                  <th>Items</th>
                  <th><i class="fas fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                {{#each actor.container as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td>
                      <div class="tableItemNameCell">
                        <div class="qty-controls">
                          <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        </div>
                        <img class="item-img" src="{{item.img}}" title="{{item.name}}"/>
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>{{item.system.container_enc.current}}/{{item.system.container_enc.max}}</td>
                    <td>{{item.system.container_enc.item_count}}</td>
                    <td>
                      <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>

          <!-- Weapons -->
          <div class="equipmentList">
            <table class="weapon-table">
              <thead>
                <tr>
                  <th class="item-name-cell item-create" id="weapon">Weapons +</th>
                  <th>Damage</th>
                  <th>Reach/Range</th>
                  <th class="right-align-cell"><i class="fas fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                {{#each actor.weapon.equipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td class="damage-entry">{{item.system.damage3}}</td>
                    <td>
                      {{#if (eq item.system.attackMode "ranged")}}
                        {{item.system.range}}
                      {{else}}
                        {{item.system.reach}}
                      {{/if}}
                    </td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
                {{#each actor.weapon.unequipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td class="damage-entry">{{item.system.damage3}}</td>
                    <td>
                      {{#if (eq item.system.attackMode "ranged")}}
                        {{item.system.range}}
                      {{else}}
                        {{item.system.reach}}
                      {{/if}}
                    </td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
              </tbody>
            </table>

            <!-- Ammunition -->
            <table class="ammunition-table">
              <thead>
                <tr>
                  <th class="item-name-cell item-create" id="ammunition">Ammunition +</th>
                  <th>Bonus</th>
                  <th>Qty</th>
                  <th class="right-align-cell"><i class="fas fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                {{#each actor.ammunition.equipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>{{item.system.damage}}</td>
                    <td><button type="button" class="minusQty plusQty" title="Click to Increase, right-click to decrease">{{item.system.quantity}}</button></td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
                {{#each actor.ammunition.unequipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>{{item.system.damage}}</td>
                    <td><button type="button" class="minusQty plusQty" title="Click to Increase, right-click to decrease">{{item.system.quantity}}</button></td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
              </tbody>
            </table>

            <!-- Armor -->
            <table class="armor-table">
              <thead>
                <tr>
                  <th class="item-name-cell item-create" id="armor" data-alt-type="item">Armor +</th>
                  <th>AR</th>
                  <th>MR</th>
                  <th>BR</th>
                  <th class="right-align-cell"><i class="fas fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                {{#each actor.armor.equipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>{{#if item.system.armorEffective}}{{item.system.armorEffective}}{{else}}{{item.system.armor}}{{/if}}</td>
                    <td>{{#if item.system.magic_arEffective}}{{item.system.magic_arEffective}}{{#if item.system.special_ar_typeEffective}} {{item.system.special_ar_typeEffective}}{{/if}}{{else}}{{item.system.magic_ar}}{{/if}}</td>
                    <td>{{#if item.system.blockRatingEffective}}{{item.system.blockRatingEffective}}{{else}}{{item.system.blockRating}}{{/if}}</td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
                {{#each actor.armor.unequipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td class="item-name-cell">
                      <div class="flex-container">
                        <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        <img class="item-img" src="{{item.img}}">
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>{{#if item.system.armorEffective}}{{item.system.armorEffective}}{{else}}{{item.system.armor}}{{/if}}</td>
                    <td>{{#if item.system.magic_arEffective}}{{item.system.magic_arEffective}}{{#if item.system.special_ar_typeEffective}} {{item.system.special_ar_typeEffective}}{{/if}}{{else}}{{item.system.magic_ar}}{{/if}}</td>
                    <td>{{#if item.system.blockRatingEffective}}{{item.system.blockRatingEffective}}{{else}}{{item.system.blockRating}}{{/if}}</td>
                    <td class="right-align-cell"><a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a></td>
                  </tr>
                {{/each}}
              </tbody>
            </table>

            <!-- Gear/Items -->
            <table>
              <thead>
                <tr>
                  <th class="item-name-cell item-create" id="createSelect">Items +</th>
                  <th>Qty</th>
                  <th><i class="fas fa-trash"></i></th>
                </tr>
              </thead>
              <tbody>
                {{#each actor.gear.equipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td>
                      <div class="tableItemNameCell">
                        <div class="qty-controls">
                          <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        </div>
                        <img class="item-img" src="{{item.img}}" title="{{item.name}}"/>
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>
                      <button type="button" class="minusQty plusQty" title="Click to Increase, right-click to decrease">
                        <div>{{item.system.quantity}}</div>
                      </button>
                    </td>
                    <td>
                      <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </td>
                  </tr>
                {{/each}}
                {{#each actor.gear.unequipped as |item id|}}
                  <tr class="item active" data-item-id="{{item._id}}" data-item-type="{{item.type}}">
                    <td>
                      <div class="tableItemNameCell">
                        <div class="qty-controls">
                          <input type="checkbox" class="itemEquip checkbox" {{checked item.system.equipped}} title="Equip">
                        </div>
                        <img class="item-img" src="{{item.img}}" title="{{item.name}}"/>
                        {{#if item.system.containerStats.contained}}
                          <i title="Open Container" class="fa-solid fa-backpack" data-container-id="{{item.system.containerStats.container_id}}"></i>
                        {{/if}}
                        <div class="item-name">{{item.name}}</div>
                      </div>
                    </td>
                    <td>
                      <button type="button" class="minusQty plusQty" title="Click to Increase, right-click to decrease">
                        <div>{{item.system.quantity}}</div>
                      </button>
                    </td>
                    <td>
                      <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Travel Tab -->
      <div class="tab travel" data-group="primary" data-tab="travel">
        <h3>Travel & Movement</h3>
        
        <div class="travel-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
          <div class="stat-card">
            <h4>Group Speed</h4>
            <div style="font-size: 20px; font-weight: bold;">{{displayAverageSpeed}} m/round</div>
            <div style="font-size: 16px; font-weight: bold; margin-top: 4px; color: #0064c8;">{{displayAverageSpeedKmh}} km/h</div>
            <p style="opacity: 0.7; font-size: 12px; margin-top: 4px;">Speed of slowest member with pace multiplier</p>
          </div>

          <div class="stat-card">
            <h4>Travel Pace</h4>
            <div style="display: flex; align-items: center; gap: 10px;">
              <button type="button" class="change-pace" style="flex: 1; padding: 8px; font-size: 14px; font-weight: bold;">
                {{#if (eq currentPace "fast")}}Fast{{/if}}
                {{#if (eq currentPace "normal")}}Normal{{/if}}
                {{#if (eq currentPace "slow")}}Slow{{/if}}
              </button>
            </div>
            <p style="opacity: 0.7; font-size: 12px; margin-top: 5px;">Click to cycle pace (affects speed display)</p>
          </div>
        </div>

        <div class="pace-reference" style="margin-top: 20px;">
          <h4>Travel Pace Reference (RAW Chapter 1)</h4>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #ccc;">
                <th style="padding: 8px; text-align: left;">Pace</th>
                <th style="padding: 8px; text-align: center;">Speed (km/h)</th>
                <th style="padding: 8px; text-align: center;">Daily (8 hours)</th>
                <th style="padding: 8px; text-align: left;">Effect</th>
              </tr>
            </thead>
            <tbody>
              <tr style="{{#if (eq currentPace 'fast')}}background: rgba(0,100,200,0.1);{{/if}}">
                <td style="padding: 8px;"><b>Fast</b></td>
                <td style="padding: 8px; text-align: center;">7 km/h</td>
                <td style="padding: 8px; text-align: center;">56 km</td>
                <td style="padding: 8px;">−20 to Observe</td>
              </tr>
              <tr style="{{#if (eq currentPace 'normal')}}background: rgba(0,100,200,0.1);{{/if}}">
                <td style="padding: 8px;"><b>Normal</b></td>
                <td style="padding: 8px; text-align: center;">5 km/h</td>
                <td style="padding: 8px; text-align: center;">40 km</td>
                <td style="padding: 8px;">—</td>
              </tr>
              <tr style="{{#if (eq currentPace 'slow')}}background: rgba(0,100,200,0.1);{{/if}}">
                <td style="padding: 8px;"><b>Slow</b></td>
                <td style="padding: 8px; text-align: center;">3 km/h</td>
                <td style="padding: 8px; text-align: center;">24 km</td>
                <td style="padding: 8px;">Can move stealthily</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Details Tab -->
      <div class="tab details" data-group="primary" data-tab="details">
        <div class="editor-section">
          <h3>Description</h3>
          {{editor actor.system.enrichedDescription target="system.description" engine="prosemirror" button=true owner=owner editable=editable}}
        </div>

        <div class="editor-section" style="margin-top: 20px;">
          <h3>Notes</h3>
          {{editor actor.system.enrichedNotes target="system.notes" engine="prosemirror" button=true owner=owner editable=editable}}
        </div>
      </div>

    </section>
  </div>
</form>
