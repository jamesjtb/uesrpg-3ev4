const { readFileSync, writeFileSync } = require('fs');
const { execSync } = require('child_process');
const { argv } = require('process');

const tag = argv[2];

if (!tag) {
  console.error('Error: No tag specified');
  console.error('Usage: node generate-release-notes.js <tag>');
  process.exit(1);
}

// Validate tag format to prevent command injection
// Only allow semantic version format with optional v prefix and RC/beta suffixes
if (!/^v?\d+\.\d+\.\d+(-[a-zA-Z0-9.]+)?$/.test(tag)) {
  console.error('Error: Invalid tag format. Expected semantic version format (e.g., v1.0.0, v1.0.0-RC.77)');
  process.exit(1);
}

console.log(`Generating release notes for tag: ${tag}`);

// Read system.json to get compatibility info
const systemObj = JSON.parse(readFileSync('./system.json', 'utf-8'));
const minVersion = systemObj.compatibility?.minimum || 'N/A';
const verifiedVersion = systemObj.compatibility?.verified || 'N/A';

// Read the template
const template = readFileSync('.github/RELEASE_TEMPLATE.md', 'utf-8');

// Get auto-generated release notes from GitHub
let autoGeneratedNotes = '';
try {
  // Generate notes using GitHub CLI
  autoGeneratedNotes = execSync(
    `gh api repos/:owner/:repo/releases/generate-notes -f tag_name=${tag} -q .body`,
    { encoding: 'utf-8' }
  ).trim();
} catch (error) {
  console.warn('Warning: Could not fetch auto-generated notes. Using placeholder.');
  autoGeneratedNotes = 'Release notes will be generated automatically.';
}

// Replace placeholders in template
let releaseNotes = template
  .replace(/TAG_NAME/g, tag)
  .replace(/VERSION_MIN/g, minVersion)
  .replace(/VERSION_VERIFIED/g, verifiedVersion)
  .replace('<!-- Auto-generated release notes will appear here -->', autoGeneratedNotes);

// Write to file
const outputFile = 'RELEASE_NOTES.md';
writeFileSync(outputFile, releaseNotes, 'utf-8');
console.log(`âœ“ Release notes written to ${outputFile}`);
