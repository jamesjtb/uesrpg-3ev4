_id: R5ATew8bm5CLj3zL
name: Subterfuge Roll
type: script
author: KoTybT0dunV5wS6T
img: icons/skills/social/theft-pickpocket-bribery-brown.webp
scope: global
command: |-
  let d = new Dialog({
      title: "Apply Roll Modifier",
      content: `<form>
                  <div class="dialogForm">
                  <label><b>Subterfuge Modifier: </b></label><input placeholder="ex. -20, +10" id="playerInput" value="0" style=" text-align: center; width: 50%; border-style: groove; float: right;" type="text"></input></div>
                </form>`,
      buttons: {
        one: {
          label: "Roll!",
          callback: html => {
            const playerInput = parseInt(html.find('[id="playerInput"]').val());
            let roll = new Roll("1d100");
            roll.roll({async:false});
          
            // Defensive property access guards
            const actorSys = token?.actor?.system;
            const lucky = actorSys?.lucky_numbers;
            const unlucky = actorSys?.unlucky_numbers;
            const subterfugeItem = token?.actor?.items?.find(entry => entry?.name === "Subterfuge");
            const skillValue = subterfugeItem?.system?.value ?? 0;
          
            if (roll.total === lucky?.ln1 || roll.total == lucky?.ln2 || roll.total == lucky?.ln3 || roll.total == lucky?.ln4 || roll.total == lucky?.ln5) {
              const content = `Rolls for <b>Subterfuge</b>!
              <p></p><b>Target Number: [[${skillValue}]]</b> <p></p>
              <b>Result: [[${roll.total}]]</b><p></p>
              <span style='color:green; font-size:120%;'> <b>LUCKY NUMBER!</b></span>`
          
              roll.toMessage({ user: game.user._id, speaker: ChatMessage.getSpeaker(), content: content});
          
            } else if (roll.total === unlucky?.ul1 || roll.total == unlucky?.ul2 || roll.total == unlucky?.ul3 || roll.total == unlucky?.ul4 || roll.total == unlucky?.ul5) {
              const content = `Rolls for <b>Subterfuge</b>!
              <p></p><b>Target Number: [[${skillValue}]]</b> <p></p>
              <b>Result: [[${roll.total}]]</b><p></p>
              <span style='color:red; font-size:120%;'> <b>UNLUCKY NUMBER!</b></span>`
          
              roll.toMessage({ user: game.user._id, speaker: ChatMessage.getSpeaker(), content: content});
          
            } else if (actorSys?.wounded === true) {
              const content = `Rolls for <b>Subterfuge</b>!
              <p></p><b>Target Number: [[${skillValue}]] </b> <p></p>
              <b>Result: [[${roll.total}]]</b><p></p>
              ${roll.total<=(skillValue + playerInput) ? " <span style='color:green; font-size: 120%;'> <b>SUCCESS!</b></span>" : " <span style='color:red; font-size: 120%;'> <b>FAILURE!</b></span>"}`
          
              roll.toMessage({ user: game.user._id, speaker: ChatMessage.getSpeaker(), content: content});
    
            } else {
              const content = `Rolls for <b>Subterfuge</b>!
              <p></p><b>Target Number: [[${skillValue}]]</b> <p></p>
              <b>Result: [[${roll.total}]]</b><p></p>
              ${roll.total<=(skillValue + playerInput) ? " <span style='color:green; font-size: 120%;'> <b>SUCCESS!</b></span>" : " <span style='color:red; font-size: 120%;'> <b>FAILURE!</b></span>"}`
          
              roll.toMessage({ user: game.user._id, speaker: ChatMessage.getSpeaker(), content: content});
              }
          }
        },
        two: {
          label: "Cancel",
          callback: html => console.log("Cancelled")
        }
      },
      default: "one",
      close: html => console.log()
    });
    d.render(true);
folder: null
sort: 0
flags:
  core:
    sourceId: Macro.J56f9FDYgelev2Cc
_stats:
  coreVersion: '12.331'
  systemId: null
  systemVersion: null
  createdTime: null
  modifiedTime: null
  lastModifiedBy: null
  compendiumSource: null
  duplicateSource: null
ownership:
  default: 0
  inSimu0FutxmlwqN: 3
  KoTybT0dunV5wS6T: 3
_key: '!macros!R5ATew8bm5CLj3zL'

